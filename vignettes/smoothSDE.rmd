---
title: "smoothSDE vignette"
author: "ThÃ©o Michelot"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{smoothSDE vignette}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE, error = FALSE, warning = FALSE,
  comment = NA
)
```

```{r load-package, echo = FALSE}
library(smoothSDE)
set.seed(342)
```

The R package smoothSDE implements varying-coefficient versions of several popular stochastic differential equations (SDEs). It can be used to estimate linear or non-linear relationships between SDE parameters and time-varying covariates. It also provides functions for model visualisation, uncertainty estimation, and residual analysis.

# Package description

## Varying-coefficient stochastic differential equations

Varying-coefficient SDEs, and the inferential method implemented in smoothSDE, are described by @michelot2020. The main model formulations currently implemented in the package are described in the following table.
 
| Model                                  | Name        | Parameters |                              | Link functions |
|----------------------------------------|-------------|------------|------------------------------|----------------|
| Brownian motion                        | "BM"        | drift      | $\mu \in (-\infty, +\infty)$ | identity       |
|                                        |             | diffusion  | $\sigma > 0$                 | log            |
| Ornstein-Uhlenbeck process             | "OU"        | mean       | $\mu \in (-\infty, +\infty)$ | identity       |
|                                        |             | reversion  | $\beta > 0$                  | log            |
|                                        |             | diffusion  | $\sigma > 0$                 | log            |
| Continuous-time correlated random walk | "CTCRW"     | reversion  | $\beta > 0$                  | log            |
|                                        |             | diffusion  | $\sigma > 0$                 | log            |

## SDE model class

The package is centred around the R6 class _SDE_, which encapsulates the model formulas and the data for a varying-coefficient SDE model. The constructor SDE\$new can be used to create a model object, and its main arguments are:

 - formulas: List of formulas for the parameters of the SDE. The formulas can include terms from standard R expressions, as well as smooth terms and random effects from the mgcv package (@wood2017).

 - data: Data frame with columns for the response variable, for the covariate, for ID, and for time.

 - type: Type of SDE; options are "BM" (Brownian motion), "OU" (Ornstein-Uhlenbeck), "CTCRW" (continuous-time correlated random walk).

 - response: Name of response variable(s).

# Example: elephant movement analysis

The following code can be used to fit the varying-coefficient CTCRW model to elephant GPS data from @wall2014, as described in Section 3.2 of @michelot2020.

We first download the data from the Movebank data repository, and keep the relevant rows and columns. Note that the CTCRW model requires projected Easting-Northing locations (rather than longitude-latitude), so that's what we are working with here.
```{r example-prep, eval = FALSE}
# Load data and keep relevant columns
URL <- paste0("https://www.datarepository.movebank.org/bitstream/handle/",
              "10255/move.373/Elliptical%20Time-Density%20Model%20%28Wall%",
              "20et%20al.%202014%29%20African%20Elephant%20Dataset%20%",
              "28Source-Save%20the%20Elephants%29.csv")
raw <- read.csv(url(URL))
keep_cols <- c(11, 13, 14, 17, 4, 5, 6)
raw_cols <- raw[, keep_cols]
colnames(raw_cols) <- c("ID", "x", "y", "date", "lon", "lat", "temp")

# Only keep five months to eliminate seasonal effects
track <- subset(raw_cols, ID == unique(ID)[1])
dates <- as.POSIXlt(track$date, tz = "GMT")
times <- as.numeric(dates - min(dates))/3600
keep_rows <- which(dates > as.POSIXct("2009-05-01 00:00:00") & 
                       dates < as.POSIXct("2009-09-30 23:59:59"))
track <- track[keep_rows,]
dates <- dates[keep_rows]
times <- times[keep_rows]

# Convert to km
track$x <- track$x/1000
track$y <- track$y/1000
```

We create a data frame that includes columns for

 - time series identifier "ID". This is required when fitting the model to several time series, treated as independent realisations of the same underlying process. Here, we only have one time series, so all rows have the same ID.
 
 - responses "x" and "y". Here, there are two response variables because the CTCRW model works in two dimensions (Easting and Northing). For other models, such as Brownian motion and Ornstein-Uhlenbeck process, only one response variable is expected.

 - covariate "temp". We will later estimate the effect of this covariate on the parameters of the elephant's velocity process.
 
 - time. This should be a numeric column for time, used to compute time intervals between observations.
 
```{r example-data, eval = FALSE}
data <- data.frame(ID = 1, 
                   x = track$x, 
                   y = track$y, 
                   temp = track$temp, 
                   time = times)

head(data)
```

In this analysis, we want to look into the effects of external temperature on the elephant's movement. We specify this by expressing both parameters of the CTCRW model (velocity reversion $\beta$ and velocity diffusion $\sigma$) as smooth functions of the temperature. For these smooth terms, we use the syntax from the R package mgcv; here defining cubic regression splines with 10 basis functions and with shrinkage. See the [mgcv documentation](https://stat.ethz.ch/R-manual/R-patched/library/mgcv/html/smooth.terms.html) for more details.

``` {r example-form, eval = FALSE}
formulas <- list(beta = ~ s(temp, k = 10, bs = "cs"), 
                 sigma = ~ s(temp, k = 10, bs = "cs"))
```


Finally, we use the constructor of the SDE class to create an object for this model, passing as input the formulas, data, type of model, and name of response variables.

``` {r example-create, eval = FALSE}
my_sde <- SDE$new(formulas = formulas, 
                  data = data, 
                  type = "CTCRW", 
                  response = c("x", "y"))
```

Once the model has been created, the parameters can be estimated using the method "fit":

``` {r example-fit, eval = FALSE}
my_sde$fit()
```

Finally, the relationship between the SDE parameters and the covariates can be plotted with the method "plot_par". The function can also generate posterior samples for the estimated relationship, to visualise uncertainty. Here, we plot the CTCRW parameters as function of temperature, with 100 posterior samples:

``` {r example-plot, eval = FALSE}
my_sde$plot_par("temp", n_post = 100)
```

As described by @michelot2020, these results suggest that this elephant tended to move less at high temperatures, with a big drop in speed over 40 degrees Celsius.

# To-do list

    - Non-zero mean velocity in CTCRW model
    
    - Two-dimensional OU process
    
    - One-dimensional CTCRW process
 
    - Write longer vignette, including a general presentation of the package (R6, different models, reference to arXiv preprint), and a couple of detailed analyses (one with BM/OU and one with CTCRW?).
    
    - Implement decaying-response model
    
    - Write predict method similar to hmmTMB
    
    - Simulation function?
    
# References
